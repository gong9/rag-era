generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String          @id @default(uuid())
  username      String          @unique
  password      String
  role          String          @default("user")
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  knowledgeBases KnowledgeBase[]
  chatSessions  ChatSession[]
  chatHistories ChatHistory[]
  codeBases     CodeBase[]
}

model KnowledgeBase {
  id          String     @id @default(uuid())
  name        String
  description String?
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents   Document[]
  evalRuns    EvalRun[]
  memories    Memory[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([userId])
}

model Document {
  id              String        @id @default(uuid())
  name            String
  path            String
  content         String?       // 原始文本内容（用于全文搜索和总结）
  wordCount       Int           @default(0)  // 字数统计
  status          String        @default("pending")
  errorMessage    String?
  knowledgeBaseId String
  knowledgeBase   KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([knowledgeBaseId])
}

model ChatSession {
  id              String         @id @default(uuid())
  title           String         @default("新对话")
  knowledgeBaseId String         // 可以是知识库 ID 或 "codebase_xxx" 格式（无外键约束）
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatHistories   ChatHistory[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([knowledgeBaseId])
  @@index([userId])
}

model ChatHistory {
  id              String         @id @default(uuid())
  sessionId       String
  knowledgeBaseId String         // 可以是知识库 ID 或 "codebase_xxx" 格式（无外键约束）
  userId          String
  question        String
  answer          String
  sourceNodes     String?
  session         ChatSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime       @default(now())

  @@index([sessionId])
  @@index([knowledgeBaseId])
  @@index([userId])
}

// ==================== 智能记忆系统 ====================

model Memory {
  id              String        @id @default(uuid())
  knowledgeBaseId String
  knowledgeBase   KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  
  content         String        // 提取的记忆内容
  type            String        // preference | fact | context | instruction
  confidence      Float         @default(0.8)
  
  // 新鲜度相关
  accessCount     Int           @default(0)
  lastAccessedAt  DateTime      @default(now())
  createdAt       DateTime      @default(now())
  
  // 向量索引（存储在 LlamaIndex 中，这里存 node_id）
  vectorNodeId    String?
  
  @@index([knowledgeBaseId])
  @@index([lastAccessedAt])
}

// ==================== RAG 评估系统 ====================

model EvalRun {
  id              String        @id @default(uuid())
  knowledgeBaseId String
  knowledgeBase   KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  status          String        @default("pending") // pending | running | completed | failed
  questions       String?       // JSON: 评估问题列表
  totalQuestions  Int           @default(0)
  completedCount  Int           @default(0)
  avgRetrievalScore Float?
  avgFaithScore     Float?
  avgQualityScore   Float?
  avgToolScore      Float?
  avgOverallScore   Float?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  results         EvalResult[]

  @@index([knowledgeBaseId])
  @@index([status])
}

model EvalResult {
  id              String   @id @default(uuid())
  evalRunId       String
  evalRun         EvalRun  @relation(fields: [evalRunId], references: [id], onDelete: Cascade)
  questionId      String   // 对应 eval.json 中的 id
  question        String
  answer          String
  retrievedContent String? // 检索到的内容
  toolsCalled     String?  // JSON: 调用的工具列表
  retrievalScore  Float    @default(0) // 0-5 检索相关性
  faithScore      Float    @default(0) // 0-5 忠实度
  qualityScore    Float    @default(0) // 0-5 答案质量
  toolScore       Float    @default(0) // 0-5 工具调用准确性
  avgScore        Float    @default(0) // 平均分
  retrievalReason String?  // 检索评分理由
  faithReason     String?  // 忠实度评分理由
  qualityReason   String?  // 质量评分理由
  toolReason      String?  // 工具评分理由
  createdAt       DateTime @default(now())

  @@index([evalRunId])
}

// ==================== GitHub 代码库系统 ====================

model CodeBase {
  id            String       @id @default(uuid())
  name          String
  description   String?
  githubUrl     String                           // GitHub 仓库 URL
  branch        String       @default("main")    // 分支名
  status        String       @default("pending") // pending | cloning | parsing | indexing | completed | failed
  errorMessage  String?
  fileCount     Int          @default(0)         // 代码文件数量
  lastSyncAt    DateTime?                        // 最后同步时间
  
  // 仓库结构信息（DeepWiki 风格）
  repoType      String?                          // monorepo | single | library
  mainLanguage  String?                          // 主要编程语言
  structureJson String?                          // JSON: 完整结构分析结果（缓存）
  
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  codeFiles     CodeFile[]
  codeSymbols   CodeSymbol[]                     // 代码符号（函数、类等）
  repoModules   RepoModule[]                     // 模块列表
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([userId])
}

model CodeFile {
  id          String    @id @default(uuid())
  path        String                             // 文件相对路径
  language    String                             // ts | tsx | js | jsx | md | json
  content     String?                            // 原始内容
  lineCount   Int       @default(0)              // 行数
  codeBaseId  String
  codeBase    CodeBase  @relation(fields: [codeBaseId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())

  @@index([codeBaseId])
}

// ==================== 模块图系统（DeepWiki 风格）====================

// 仓库模块（Layer 1: Module Graph）
model RepoModule {
  id            String   @id @default(uuid())
  codeBaseId    String
  codeBase      CodeBase @relation(fields: [codeBaseId], references: [id], onDelete: Cascade)
  
  // 基础信息
  name          String                           // 模块名: react-reconciler
  path          String                           // 模块路径: packages/react-reconciler
  entryFile     String?                          // 入口文件: src/index.ts
  version       String?                          // 版本号
  
  // LLM 生成的语义信息
  summary       String?                          // 模块摘要
  responsibilities String?                       // JSON: 关键职责列表
  publicAPI     String?                          // JSON: 公共 API 列表
  readme        String?                          // 模块 README 内容
  
  // 向量索引
  embedding     String?                          // JSON: 摘要的 embedding 向量
  
  // 深索引状态
  deepIndexed   Boolean  @default(false)         // 是否已深度索引
  deepIndexAt   DateTime?                        // 深度索引时间
  
  // 关联
  symbols       CodeSymbol[]                     // 模块内的符号
  dependencies  ModuleDependency[] @relation("DependsOn")   // 依赖的模块
  dependents    ModuleDependency[] @relation("DependedBy")  // 被依赖的模块
  
  createdAt     DateTime @default(now())

  @@index([codeBaseId])
  @@index([name])
}

// 模块依赖关系（模块图的边）
model ModuleDependency {
  id          String     @id @default(uuid())
  fromId      String
  toId        String
  from        RepoModule @relation("DependsOn", fields: [fromId], references: [id], onDelete: Cascade)
  to          RepoModule @relation("DependedBy", fields: [toId], references: [id], onDelete: Cascade)
  
  type        String     @default("import")      // import | extends | implements | uses
  
  @@unique([fromId, toId])
  @@index([fromId])
  @@index([toId])
}

// ==================== 代码符号系统（用于搜索）====================

// 代码符号（函数、类、方法等）- 用于关键词搜索
model CodeSymbol {
  id          String     @id @default(uuid())
  codeBaseId  String
  codeBase    CodeBase   @relation(fields: [codeBaseId], references: [id], onDelete: Cascade)
  
  // 基础信息
  name        String                             // 符号名称: createApp
  qualifiedName String?                          // 完整限定名: packages/runtime-core/src/apiCreateApp.ts:createApp
  type        String                             // function | class | method | variable | interface
  filePath    String                             // 文件相对路径
  startLine   Int
  endLine     Int
  signature   String?                            // 函数签名
  exported    Boolean    @default(false)
  
  // 模块归属
  moduleId    String?                            // 所属模块 ID
  module      RepoModule? @relation(fields: [moduleId], references: [id])
  
  // 语义信息（从注释/JSDoc 提取）
  docComment  String?                            // JSDoc/docstring 原文
  semanticTags String?                           // JSON: 语义标签
  
  createdAt   DateTime   @default(now())

  @@index([codeBaseId])
  @@index([moduleId])
  @@index([name])
  @@index([filePath])
}

