generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String          @id @default(uuid())
  username      String          @unique
  password      String
  role          String          @default("user")
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  knowledgeBases KnowledgeBase[]
  chatSessions  ChatSession[]
  chatHistories ChatHistory[]
}

model KnowledgeBase {
  id          String     @id @default(uuid())
  name        String
  description String?
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents   Document[]
  chatSessions ChatSession[]
  chatHistories ChatHistory[]
  evalRuns    EvalRun[]
  memories    Memory[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([userId])
}

model Document {
  id              String        @id @default(uuid())
  name            String
  path            String
  content         String?       // 原始文本内容（用于全文搜索和总结）
  wordCount       Int           @default(0)  // 字数统计
  status          String        @default("pending")
  errorMessage    String?
  knowledgeBaseId String
  knowledgeBase   KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([knowledgeBaseId])
}

model ChatSession {
  id              String        @id @default(uuid())
  title           String        @default("新对话")
  knowledgeBaseId String
  userId          String
  knowledgeBase   KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatHistories   ChatHistory[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([knowledgeBaseId])
  @@index([userId])
}

model ChatHistory {
  id              String        @id @default(uuid())
  sessionId       String
  knowledgeBaseId String
  userId          String
  question        String
  answer          String
  sourceNodes     String?
  session         ChatSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  knowledgeBase   KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())

  @@index([sessionId])
  @@index([knowledgeBaseId])
  @@index([userId])
}

// ==================== 智能记忆系统 ====================

model Memory {
  id              String        @id @default(uuid())
  knowledgeBaseId String
  knowledgeBase   KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  
  content         String        // 提取的记忆内容
  type            String        // preference | fact | context | instruction
  confidence      Float         @default(0.8)
  
  // 新鲜度相关
  accessCount     Int           @default(0)
  lastAccessedAt  DateTime      @default(now())
  createdAt       DateTime      @default(now())
  
  // 向量索引（存储在 LlamaIndex 中，这里存 node_id）
  vectorNodeId    String?
  
  @@index([knowledgeBaseId])
  @@index([lastAccessedAt])
}

// ==================== RAG 评估系统 ====================

model EvalRun {
  id              String        @id @default(uuid())
  knowledgeBaseId String
  knowledgeBase   KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  status          String        @default("pending") // pending | running | completed | failed
  questions       String?       // JSON: 评估问题列表
  totalQuestions  Int           @default(0)
  completedCount  Int           @default(0)
  avgRetrievalScore Float?
  avgFaithScore     Float?
  avgQualityScore   Float?
  avgToolScore      Float?
  avgOverallScore   Float?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  results         EvalResult[]

  @@index([knowledgeBaseId])
  @@index([status])
}

model EvalResult {
  id              String   @id @default(uuid())
  evalRunId       String
  evalRun         EvalRun  @relation(fields: [evalRunId], references: [id], onDelete: Cascade)
  questionId      String   // 对应 eval.json 中的 id
  question        String
  answer          String
  retrievedContent String? // 检索到的内容
  toolsCalled     String?  // JSON: 调用的工具列表
  retrievalScore  Float    @default(0) // 0-5 检索相关性
  faithScore      Float    @default(0) // 0-5 忠实度
  qualityScore    Float    @default(0) // 0-5 答案质量
  toolScore       Float    @default(0) // 0-5 工具调用准确性
  avgScore        Float    @default(0) // 平均分
  retrievalReason String?  // 检索评分理由
  faithReason     String?  // 忠实度评分理由
  qualityReason   String?  // 质量评分理由
  toolReason      String?  // 工具评分理由
  createdAt       DateTime @default(now())

  @@index([evalRunId])
}

